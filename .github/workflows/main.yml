name: ğŸ—ï¸ Initialize & Run Profit Machine

on:
  workflow_dispatch: # á‰ áŠ¥áŒ…áˆ… "Run workflow" áˆµá‰µáˆˆá‹ á‰¥á‰» áŠ¥áŠ•á‹²áˆ°áˆ«
  schedule:
    - cron: '0 8,14,20 * * *' # á‰ á‰€áŠ• 3 áŒŠá‹œ á‰ áˆ«áˆ± á‹­áˆ®áŒ£áˆ

# áˆˆ GitHub Actions á‹á‹­áˆá‰½áŠ• á‹¨áˆ˜áŒ»á áˆá‰ƒá‹µ áˆ˜áˆµáŒ á‰µ
permissions:
  contents: write

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # áˆáˆ‰áŠ•áˆ á‰³áˆªáŠ­ áŠ¥áŠ•á‹²á‹«áˆ˜áŒ£

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install python-dotenv requests groq

      - name: ğŸ—ï¸ Create Structure (If missing)
        run: |
          # áˆ˜á‹‹á‰…áˆ© áˆ˜áŠ–áˆ©áŠ• á‹«áˆ¨áŒ‹áŒáŒ£áˆá£ áŠ¨áˆŒáˆˆ á‹­áˆáŒ¥áˆ«áˆ
          if [ -f create_structure.py ]; then
            python create_structure.py
          else
            echo "âš ï¸ create_structure.py not found, skipping..."
          fi

      - name: ğŸš€ Run Master Controller
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          # á‹‹áŠ“á‹ áŠ®áŠ•á‰µáˆ®áˆˆáˆ­ áŠ«áˆˆ á‹«áˆµáŠáˆ³á‹‹áˆ
          if [ -f main_controller.py ]; then
            python main_controller.py --workflow daily --mode hybrid
          else
            echo "â„¹ï¸ main_controller.py not created yet. Setup only mode."
          fi

      - name: ğŸ“¤ Push Changes to GitHub
        if: always()
        run: |
          git config --global user.email "github-actions@users.noreply.github.com"
          git config --global user.name "GitHub Actions"
          
          # áŠ á‹³á‹²áˆµ á‹¨á‰°áˆáŒ áˆ© ááˆá‹°áˆ®á‰½áŠ• áŠ¥áŠ“ á‹á‹­áˆá‰½áŠ• áˆ˜áˆ˜á‹áŒˆá‰¥
          git add .
          
          # áˆˆá‹áŒ¥ áŠ«áˆˆ á‰¥á‰» Commit áŠ¥áŠ•á‹²á‹«á‹°áˆ­áŒ
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ¤– Auto-Update: Structure & Results [Run ID: ${{ github.run_id }}]"
            git push origin main
          fi

      - name: ğŸ“Š Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: execution-output
          path: |
            exports/
            logs/
            data/*.json
