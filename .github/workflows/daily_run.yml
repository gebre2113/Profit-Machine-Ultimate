name: Daily Profit Machine Run

on:
  schedule:
    # рЅарІерЅђріЉ ріЦріЕрѕѕ рѕїрѕірЅх рѕІрІГ рІГріљрѕ│рѕЇ (UTC рѕ░рІЊрЅх)
    - cron: '0 0 * * *'  # рЅаріЦрѕѕрЅх 12:00 AM UTC
  workflow_dispatch:      # ріЦрїЁ рѕѕрѕЏрѕхріљрѕ│рЅх
    inputs:
      version:
        description: 'рІерѕџрѕхрігрІ░рІЇ рѕхрѕфрЅх'
        required: false
        default: 'all'
        type: choice
        options:
        - v9
        - v10
        - v11
        - all
      topic:
        description: 'рѕГрІЋрѕ░ рїЅрІ│рІГ (рІѕрІГрѕЮ "default" рѕѕріљрЅБрѕф рѕГрІЋрѕ░ рїЅрІ│рІ«рЅй)'
        required: false
        default: 'default'
        type: string

jobs:
  profit-engine-run:
    runs-on: ubuntu-latest
    
    env:
      TZ: 'Africa/Addis_Ababa'  # рІерібрЅхрІ«рїхрІФ рѕ░рІЊрЅх рѕ░рїф
    
    steps:
    - name: ­ЪЊЦ рі«рІх рѕўрІЇрѕ░рІх
      uses: actions/checkout@v4
    
    - name: ­ЪљЇ рЇЊрІГрЅХріЋ ріарІІрЅЁрѕГ
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ­ЪЊд ріарѕхрЇѕрѕІрїі рѕърїЂрѕјрЅй рѕўрїФріЋ
      run: |
        python -m pip install --upgrade pip
        pip install requests python-dotenv colorama
    
    - name: ­ЪћД рІерѕхрѕГрІЊрЅх ріарІІрЅЁрѕГ
      run: |
        # ріарѕхрЇѕрѕІрїі рЇјрѕЇрІ░рѕ«рЅй рѕўрЇЇрїарѕГ
        mkdir -p logs exports comparisons batch_reports
        mkdir -p V9 v10 v11
        
        # рѕўрѕ░рѕерЅ│рІі рЅЁріЋрЅЦрѕГ рЇІрІГрѕЇ рѕўрЇЇрїарѕГ (ріФрѕЇрЅ░рїѕріў)
        if [ ! -f master_config.json ]; then
          echo '{
            "project_name": "Profit Machine Enterprise",
            "default_language": "english",
            "version": "1.0.0",
            "api_settings": {
              "max_retries": 3,
              "cache_duration": 3600
            },
            "version_overrides": {
              "v9": { "simple_mode": true },
              "v10": { "automation": true },
              "v11": { "enterprise_features": true }
            }
          }' > master_config.json
        fi
        
        # рІерѕхрѕГрІЊрЅх рѕўрѕерїЃ
        echo "­ЪЊі рѕхрѕГрІЊрЅх рѕўрѕерїЃ:"
        echo "Python version: $(python --version)"
        echo "Current directory: $(pwd)"
        ls -la

    - name: ­ЪЊЂ ріарѕхрЇѕрѕІрїі рЇјрѕЇрІ░рѕ«рЅй рѕўрЇЇрїарѕГ
      run: |
        # рѕѕріарІ▓рѕх рѕЏрѕйріЋ рѕІрІГ рІФрѕѕ рЇјрѕЇрІ░рѕГ рѕхрѕЁрЅ░рЅх рѕѕрѕЏрѕхрЅђрѕерЅх
        echo "­ЪЊѓ ріарѕхрЇѕрѕІрїі рЇјрѕЇрІ░рѕ«рЅйріЋ ріЦрІерЇѕрїарѕГріЕ ріљрІЇ..."
        mkdir -p exports logs data comparisons batch_reports
        mkdir -p V9 v10 v11
        
        # рЅБрІХ рѕЏрЅєрІФ (placeholder) рЇІрІГрѕјрЅй рѕўрЇЇрїарѕГ
        echo "­ЪЊё рЅБрІХ рЇІрІГрѕјрЅйріЋ ріЦрІерЇѕрїарѕГріЕ ріљрІЇ..."
        echo "{}" > exports/backup_info.json
        echo "[]" > exports/results_cache.json
        echo "{}" > data/analytics_data.json
        
        # рЇјрѕЇрІ░рѕГ рІЇрѕхрїЦ рІФрѕѕрІЇріЋ рІГрІўрЅх рѕЏрѕ│рІерЅх
        echo "РюЁ рІерЅ░рЇѕрїарѕЕ рЇјрѕЇрІ░рѕ«рЅй:"
        ls -la exports/ logs/ data/
    
    - name: ­Ъџђ рІерЅхрѕГрЇЇ рѕЏрѕйріЋ рѕЏрѕхріљрѕ│рЅх
      env:
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        SERPER_API_KEY: ${{ secrets.SERPER_API_KEY }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        echo "­ЪћЉ рІеріцрЇњріарІГ рЅЂрѕЇрЇјрЅй рЅ░рїГріљрІІрѕЇ:"
        echo "GROQ_API_KEY: $(if [ -n "$GROQ_API_KEY" ]; then echo "РюЁ"; else echo "РЮї"; fi)"
        echo "NEWS_API_KEY: $(if [ -n "$NEWS_API_KEY" ]; then echo "РюЁ"; else echo "РЮї"; fi)"
        echo "SERPER_API_KEY: $(if [ -n "$SERPER_API_KEY" ]; then echo "РюЁ"; else echo "РЮї"; fi)"
        
        # рЅарѕЮріЋ рѕўрѕѕріфрІФ ріЦріЋрІ░рѕџрѕ░рѕФ рѕўрІѕрѕ░ріЋ
        VERSION="${{ github.event.inputs.version || 'all' }}"
        TOPIC="${{ github.event.inputs.topic || 'default' }}"
        
        echo "­Ъј» рІерѕхрѕФ рѕўрѕѕріфрІФрІјрЅй:"
        echo "рѕхрѕфрЅх: $VERSION"
        echo "рѕГрІЋрѕ░ рїЅрІ│рІГ: $TOPIC"
        
        # рІерѕџрѕхрігрІ▒ рѕГрІЋрѕ░ рїЅрІ│рІ«рЅй
        if [ "$TOPIC" = "default" ]; then
          if [ "$VERSION" = "v9" ]; then
            TOPICS=("Small Businesses in Ethiopia" "Technology Trends" "Agriculture Innovation")
          elif [ "$VERSION" = "v10" ]; then
            TOPICS=("Digital Marketing Strategies" "E-commerce Growth" "Remote Work Benefits")
          elif [ "$VERSION" = "v11" ]; then
            TOPICS=("AI Investment Strategies" "Market Expansion Plans" "Sustainable Business Models")
          else
            TOPICS=("Global Technology Trends" "Business Innovation" "Economic Growth Opportunities")
          fi
        else
          TOPICS=("$TOPIC")
        fi
        
        # рІІріЊ рѕхріГрѕфрЇЋрЅх рѕЏрѕхріљрѕ│рЅх
        echo "­Ъџђ рІерЅхрѕГрЇЇ рѕЏрѕйріЋ ріЦрІерЅ░ріљрѕ│ ріљрІЇ..."
        
        # рІерѕЏрѕхріљрѕ│рЅх рЅђріЋ ріЦріЊ рѕ░рІЊрЅх
        START_TIME=$(date +%s)
        DATE_TODAY=$(date +"%Y-%m-%d")
        
        # рІерѕхрѕФ рѕфрЇќрѕГрЅх рЇІрІГрѕЇ рѕўрЇЇрїарѕГ
        REPORT_FILE="run_report_${DATE_TODAY}.txt"
        echo "­ЪЊІ рІерѕхрѕФ рѕфрЇќрѕГрЅх - $DATE_TODAY" > "$REPORT_FILE"
        echo "======================================" >> "$REPORT_FILE"
        
        # рѕѕріЦрІФріЋрІ│ріЋрІ▒ рѕГрІЋрѕ░ рїЅрІ│рІГ рѕЏрѕхрігрІх
        SUCCESS_COUNT=0
        FAIL_COUNT=0
        
        for topic in "${TOPICS[@]}"; do
          echo "" >> "$REPORT_FILE"
          echo "­ЪћЇ рѕГрІЋрѕ░ рїЅрІ│рІГ: $topic" >> "$REPORT_FILE"
          echo "­ЪЋњ рІерѕўрїђрѕўрѕфрІФ рѕ░рІЊрЅх: $(date +"%H:%M:%S")" >> "$REPORT_FILE"
          
          # рЅа Python рІерЅхрѕГрЇЇ рѕЏрѕйріЋ рѕЏрѕхріљрѕ│рЅх
          if [ "$VERSION" = "all" ]; then
            # рѕХрѕхрЅ▒ріЋрѕЮ рѕхрѕфрЅХрЅй рѕЏрѕхрігрІх
            python3 -c "
import sys
import os
sys.path.append('.')
from Master_Controller import MasterController

controller = MasterController()
result = controller.run_all_versions('$topic', 'US')
print(f'РюЁ {topic} - рѕЂрѕЅрѕЮ рѕхрѕфрЅХрЅй рЅ░рїаріЊрЅђрІІрѕЇ')
            " 2>&1 | tee -a "$REPORT_FILE"
          else
            # ріаріЋрІх рѕхрѕфрЅх рЅЦрЅ╗ рѕЏрѕхрігрІх
            python3 -c "
import sys
import os
sys.path.append('.')
from Master_Controller import MasterController

controller = MasterController()
result = controller.run_version('$VERSION', '$topic', 'US')
if result.get('success'):
    print(f'РюЁ {topic} - рЅ░рѕ│ріГрЅирѕЇ')
else:
    print(f'РЮї {topic} - ріарѕЇрЅ░рѕ│ріФрѕЮ: {result.get(\"error\", \"Unknown\")}')
            " 2>&1 | tee -a "$REPORT_FILE"
          fi
          
          # рІерѕѓрІ░рЅ▒ріЋ рѕЂріћрЅ│ рѕўрѕѕрІерЅх
          if [ $? -eq 0 ]; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            echo "РюЁ рѕЂріћрЅ│: рЅ░рѕ│ріГрЅирѕЇ" >> "$REPORT_FILE"
          else
            FAIL_COUNT=$((FAIL_COUNT + 1))
            echo "РЮї рѕЂріћрЅ│: ріарѕЇрЅ░рѕ│ріФрѕЮ" >> "$REPORT_FILE"
          fi
          
          echo "­ЪЋњ рІерѕЏрЅІрѕерїФ рѕ░рІЊрЅх: $(date +"%H:%M:%S")" >> "$REPORT_FILE"
          echo "---" >> "$REPORT_FILE"
        done
        
        # рІерѕЏрїарЅЃрѕѕрІФ рѕхрѕїрЅх
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        
        echo "" >> "$REPORT_FILE"
        echo "­ЪЊі рѕЏрїарЅЃрѕѕрІФ" >> "$REPORT_FILE"
        echo "==============" >> "$REPORT_FILE"
        echo "рЅ░рѕ│ріГрЅ░рІІрѕЇ: $SUCCESS_COUNT" >> "$REPORT_FILE"
        echo "ріарѕЇрЅ░рѕ│ріЕрѕЮ: $FAIL_COUNT" >> "$REPORT_FILE"
        echo "ріарїарЅЃрѕІрІГ рїірІю: ${DURATION} рѕ░ріеріЋрІх" >> "$REPORT_FILE"
        echo "рІерѕЏрїаріЊрЅђрЅѓрІФ рѕ░рІЊрЅх: $(date +"%Y-%m-%d %H:%M:%S")" >> "$REPORT_FILE"
        
        # рІерѕфрЇќрѕГрЅх рЇІрІГрѕЇ рѕЏрѕхрЅђрѕўрїЦ
        echo "­ЪЊё рѕфрЇќрѕГрЅх рЅ░рЅђрѕЮрїДрѕЇ: $REPORT_FILE"
        
        # рІерѕхрѕФ рѕЏрїарЅЃрѕѕрІФ рѕЏрѕ│рІерЅх
        echo "­ЪјЅ рІерЅхрѕГрЇЇ рѕЏрѕйріЋ рѕхрѕФ рЅ░рїаріЊрЅІрѕЇ!"
        echo "­ЪЊѕ рІЇрїцрЅх: $SUCCESS_COUNT рЅ░рѕ│ріГрЅ░рІІрѕЇ, $FAIL_COUNT ріарѕЇрЅ░рѕ│ріЕрѕЮ"
        echo "РЈ▒№ИЈ  рїірІю: ${DURATION} рѕ░ріеріЋрІх"
    
    - name: ­ЪЊц рІЇрїцрЅХрЅйріЋ рѕЏрѕхрЅђрѕўрїЦ (Artifacts)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: profit-machine-output-${{ github.run_id }}
        path: |
          V9/
          v10/
          v11/
          exports/
          comparisons/
          batch_reports/
          logs/
          *.txt
          *.log
        retention-days: 7
    
    - name: ­ЪЊЮ рІерѕхрѕФ рѕЏрїарЅЃрѕѕрІФ рѕЏрѕ│рІерЅх
      if: always()
      run: |
        echo "­ЪЊІ рІе GitHub Actions рѕхрѕФ рЅ░рїаріЊрЅІрѕЇ"
        echo "­ЪћЌ Workflow URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "­ЪЈи№ИЈ Run ID: ${{ github.run_id }}"
        echo "­Ъј» Triggered by: ${{ github.event_name }}"
        
        # рІерІЇрїцрЅх рѕЏрїарЅЃрѕѕрІФ
        echo "­ЪЊЂ рІерЅ░рЇѕрїарѕЕ рЇІрІГрѕјрЅй:"
        echo "V9: $(ls -1 V9/ 2>/dev/null | wc -l || echo 0) рЇІрІГрѕјрЅй"
        echo "v10: $(ls -1 v10/ 2>/dev/null | wc -l || echo 0) рЇІрІГрѕјрЅй"
        echo "v11: $(ls -1 v11/ 2>/dev/null | wc -l || echo 0) рЇІрІГрѕјрЅй"
        echo "logs: $(ls -1 logs/ 2>/dev/null | wc -l || echo 0) рЇІрІГрѕјрЅй"
    
    - name: ­Ъћћ рѕЏрѕ│рІѕрЅѓрІФ (Telegram)
      if: always() && env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != ''
      run: |
        # рІерѕхрѕФ рѕЂріћрЅ│ рѕўрІѕрѕ░ріЋ
        if [ ${{ job.status }} == 'success' ]; then
          STATUS="РюЁ"
          MESSAGE="рЅарЅ░рѕ│ріФ рѕЂріћрЅ│ рЅ░рїаріЊрЅІрѕЇ"
        else
          STATUS="РЮї"
          MESSAGE="рЅйрїЇрѕГ ріарѕѕрЅарЅх"
        fi
        
        # Telegram рѕўрѕЇрІЋріГрЅх рѕўрѕІріГ
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d chat_id="${TELEGRAM_CHAT_ID}" \
          -d text="­Ъцќ Profit Machine Run ${STATUS}

${MESSAGE}
­ЪЊЁ Date: $(date +'%Y-%m-%d')
РЈ▒№ИЈ Duration: ${DURATION} seconds
­ЪЊі Results: ${SUCCESS_COUNT} succeeded, ${FAIL_COUNT} failed

­ЪћЌ View: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
          -d parse_mode="Markdown"
